cmake_minimum_required(VERSION 3.1)

project(mc_talos)

set(CMAKE_CXX_STANDARD 11)
option(USE_CONFIDENTIAL_TALOS "Use the confidential model talos_description" ON)

find_package(mc_rtc REQUIRED)
if(${USE_CONFIDENTIAL_TALOS})
  message("-- Using TALOS confidential model")
  find_package(talos_description REQUIRED)
  if("${talos_description_INSTALL_PREFIX}" STREQUAL "")
    if("${talos_description_SOURCE_PREFIX}" STREQUAL "")
      message(FATAL_ERROR "Your talos_description package does not define where to find the data")
    endif()
    set(TALOS_DESCRIPTION_PATH "${talos_description_SOURCE_PREFIX}")
  else()
    set(TALOS_DESCRIPTION_PATH "${talos_description_INSTALL_PREFIX}")
  endif()
	find_program(XACRO xacro REQUIRED)
  set(XACRO_IN "${TALOS_DESCRIPTION_PATH}/robots/talos_full_v2.urdf.xacro")
  # set(XACRO_IN "${TALOS_DESCRIPTION_PATH}/share/talos_description/robots/talos_full_v2.urdf.xacro")
  # set(XACRO_IN "/opt/pal/ferrum/share/talos_description/robots/talos_full_v2.urdf.xacro")
  set(URDF_OUT "${CMAKE_CURRENT_BINARY_DIR}/urdf/talos.urdf")
  set(TALOS_URDF_DESTINATION "${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME}")
  set(TALOS_URDF_PATH "${TALOS_URDF_DESTINATION}/talos.urdf")
  add_custom_command(OUTPUT "${URDF_OUT}" DEPENDS "${XACRO_IN}" COMMAND ${XACRO} test_dir:="${TALOS_DESCRIPTION_PATH}/test" "${XACRO_IN}" test:=false flexibility:=false foot_collision:=default enable_crane:=false disable_gazebo_camera:=false head_type:=default -o "${URDF_OUT}" VERBATIM)
  add_custom_target(generate_talos_urdf ALL DEPENDS "${URDF_OUT}")
  install(FILES "${URDF_OUT}" DESTINATION "${TALOS_URDF_DESTINATION}")
  set(TALOS_RSDF_DIR "${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME}/rsdf")
  install(DIRECTORY rsdf DESTINATION "${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME}")
  set(TALOS_CONVEX_DIR "${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME}/convex")
  install(DIRECTORY convex DESTINATION "${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME}")
  #set(TALOS_RSDF_DIR "/home/saeid/Softwares/mc-talos/rsdf")
  set(TALOS_URDF_PATH "${TALOS_URDF_DESTINATION}/talos.urdf")
else()
  message("-- Using existing Talos web model")
  find_package(talos_data REQUIRED)
  if(${talos_data_FOUND})
    if("${talos_data_INSTALL_PREFIX}" STREQUAL "")
      if("${talos_data_SOURCE_PREFIX}" STREQUAL "")
        message(FATAL_ERROR "Your talos_data package does not define where to find the data")
      endif()
      set(TALOS_DESCRIPTION_PATH "${talos_data_SOURCE_PREFIX}")
    else()
      set(TALOS_DESCRIPTION_PATH "${talos_data_INSTALL_PREFIX}")
    endif()
		set(TALOS_RSDF_DIR "${TALOS_DESCRIPTION_PATH}/rsdf")
  	set(TALOS_URDF_PATH "${TALOS_DESCRIPTION_PATH}/urdf/talos_full_v2.urdf")
  endif()
endif()

message("-- TALOS_DESCRIPTION_PATH: ${TALOS_DESCRIPTION_PATH}")
message("-- TALOS_URDF_DESTINATION: ${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME}")
message("-- TALOS_URDF_PATH: ${TALOS_URDF_DESTINATION}/talos.urdf")
configure_file(src/config.h.in "${CMAKE_CURRENT_BINARY_DIR}/include/config.h")

add_robot(talos src/talos.cpp src/talos.h)
target_include_directories(talos PRIVATE "${CMAKE_CURRENT_BINARY_DIR}/include")

option(DISABLE_TESTS "Disable unit tests" OFF)
if(NOT ${DISABLE_TESTS})
  enable_testing()
  add_subdirectory(tests)
endif()
